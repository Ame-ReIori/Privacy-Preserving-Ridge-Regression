extract_index_to_bc
big function